<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <link rel="manifest" href="/manifest.json">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            html, body {
                margin: 0px;
                padding: 0px;
                overflow: hidden;
            }
            #shell {
                width: 100vw;
                height: 100vh;
            }
            canvas {
                transform: scale(0.5, 0.5);
                transform-origin: 0 0;
            }
        </style>
        <link rel="import" href="./level.html">
        <link rel="import" href="./keyboard.html">
        <link rel="import" href="./log.html">
        <link rel="import" href="./socket-manager.html">
        <link rel="import" href="./mouse-manager.html">
    </head>
    <body>
        <template id="main-menu">
            <button type="button" id="drive-button">Drive</button>
            <button type="button" id="assist-button">Assist</button>
            <button type="button" id="start-button">Start</button>
        </template>
        <template id="game">
            <canvas id="canvas"></canvas>
        </template>
        <div id="shell"></div>
        <script>

            window.EasingFunctions = {
                // no easing, no acceleration
                linear: function (t) { return t },
                // accelerating from zero velocity
                easeInQuad: function (t) { return t*t },
                // decelerating to zero velocity
                easeOutQuad: function (t) { return t*(2-t) },
                // acceleration until halfway, then deceleration
                easeInOutQuad: function (t) { return t<.5 ? 2*t*t : -1+(4-2*t)*t },
                // accelerating from zero velocity 
                easeInCubic: function (t) { return t*t*t },
                // decelerating to zero velocity 
                easeOutCubic: function (t) { return (--t)*t*t+1 },
                // acceleration until halfway, then deceleration 
                easeInOutCubic: function (t) { return t<.5 ? 4*t*t*t : (t-1)*(2*t-2)*(2*t-2)+1 },
                // accelerating from zero velocity 
                easeInQuart: function (t) { return t*t*t*t },
                // decelerating to zero velocity 
                easeOutQuart: function (t) { return 1-(--t)*t*t*t },
                // acceleration until halfway, then deceleration
                easeInOutQuart: function (t) { return t<.5 ? 8*t*t*t*t : 1-8*(--t)*t*t*t },
                // accelerating from zero velocity
                easeInQuint: function (t) { return t*t*t*t*t },
                // decelerating to zero velocity
                easeOutQuint: function (t) { return 1+(--t)*t*t*t*t },
                // acceleration until halfway, then deceleration 
                easeInOutQuint: function (t) { return t<.5 ? 16*t*t*t*t*t : 1+16*(--t)*t*t*t*t }
            };

            let canvas = document.getElementById('canvas'),
                lastTs = 0;

            class View {
                constructor (templateId) {
                    this.shell = document.getElementById('shell');
                    this.template = document.getElementById(templateId);
                    this.root = this.template.content.cloneNode(true);
                }
                show () {
                    while (this.shell.firstChild) {
                        this.shell.removeChild(this.shell.firstChild);
                    }
                    this.shell.appendChild(this.root);
                }
            }

            class MainMenu extends View {
                constructor () {
                    super('main-menu');
                }

                show () {
                    super.show();
                    this.ready = {};
                    this.buttons = {
                        driver: this.shell.querySelector('#drive-button'),
                        assist: this.shell.querySelector('#assist-button'),
                        start: this.shell.querySelector('#start-button')
                    };
                    this.buttons.driver.addEventListener('click', () => {
                        this.chooseRole('driver');
                    });
                    this.buttons.assist.addEventListener('click', () => {
                        this.chooseRole('assist');
                    });
                    this.buttons.start.addEventListener('click', () => {
                        Socket.ready();
                    });
                    this.buttons.driver.setAttribute('disabled', true);
                    this.buttons.assist.setAttribute('disabled', true);
                    this.buttons.start.setAttribute('disabled', true);
                    Socket.connect().then((data) => {
                        ['driver', 'assist'].forEach(role => {
                            if (data.rolesTaken.indexOf(role) === -1) {
                                this.buttons[role].removeAttribute('disabled');
                            }
                        });
                        Socket.socket.on('role-choosen', (role) => {
                            this.buttons[role].setAttribute('disabled', true);
                        });

                        Socket.socket.on('all-ready', () => {
                            this.buttons.start.removeAttribute('disabled');
                        });

                        Socket.socket.on('start', (role) => {
                            this.start();
                        });
                    });
                }

                chooseRole (role) {
                    Socket.chooseRole(role).then(() => {
                        this.buttons.driver.setAttribute('disabled', true);
                        this.buttons.assist.setAttribute('disabled', true);
                    });
                }

                onStart (cb) {
                    this._onStart = cb;
                }

                start () {
                    this._onStart();
                }
            }

            class Game extends View {
                constructor () {
                    super('game');
                    this.lastTs = 0;
                }

                show () {
                    super.show();
                    this.canvas = this.shell.querySelector('#canvas');
                    window.addEventListener('resize', this.resize.bind(this));
                    this.resize();
                    Mouse.grab(window);
                    this.ctx = this.canvas.getContext('2d');
                    this.level = new Level(this.ctx, {});

                    Keyboard.grab(window);
                    Logger.setContext(this.ctx);

                    this.level.start();

                    requestAnimationFrame(this.update.bind(this));
                }

                update (ts) {
                    let dt = ts - this.lastTs;
                    this.lastTs = ts;
                    this.level.update(dt);
                    this.level.render();
                    Logger.render();
                    requestAnimationFrame(this.update.bind(this));
                }

                resize () {
                    this.canvas.width = window.innerWidth * 2;
                    this.canvas.height = window.innerHeight * 2;
                }
            }
            
            let mainMenu = new MainMenu();
            mainMenu.onStart(() => {
                let game = new Game();
                game.show();
            });
            mainMenu.show();
        </script>
    </body>
</html>