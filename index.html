<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <link rel="manifest" href="/manifest.json">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/style/main.css">
        <link rel="stylesheet" href="/style/fonts.css">
        <link rel="stylesheet" href="/style/role-screen.css">
        <link rel="stylesheet" href="/style/main-menu.css">
        <link rel="stylesheet" href="/style/inventory.css">
        <link rel="import" href="./util/chance.html">
        <link rel="import" href="./level.html">
        <link rel="import" href="./keyboard.html">
        <link rel="import" href="./log.html">
        <link rel="import" href="./socket-manager.html">
        <link rel="import" href="./mouse-manager.html">
    </head>
    <body>
        <template id="main-menu">
            <div class="main-menu">
                <div class="drive" data-role="menu-driver">
                    <h1>Pilot</h1>
                    <img src="/assets/avatar/driver.svg" alt="">
                    <button type="button">Drive</button>
                </div>
                <div class="assist" data-role="menu-assist">
                    <h1>Navigator</h1>
                    <img src="/assets/avatar/assist.svg" alt="">
                    <button type="button">Assist</button>
                </div>
                <div class="alt-buttons">
                    <button type="button" data-role="game-start-solo">Solo Mode</button>
                    <button type="button" data-role="game-start">Start</button>
                </div>
            </div>
        </template>
        <template id="game">
            <canvas id="canvas"></canvas>
            <div class="game-over" id="game-over-overlay">
                <img src="/assets/logo/death.svg" alt="">
                <button id="retry">Retry</button>
            </div>
        </template>
        <template id="role-screen">
            <div class="role-screen">
                <div class="inner">
                    <img class="avatar show-role-driver" src="/assets/avatar/driver.svg" />
                    <img class="marker show-role-driver" src="/assets/marker/driver.svg" />
                    <img class="avatar show-role-assist" src="/assets/avatar/assist.svg" />
                    <img class="marker show-role-assist" src="/assets/marker/assist.svg" />
                    <h1 data-role='score'></h1>
                    <h2 class="show-role-driver">Pilot</h2>
                    <h2 class="show-role-assist">Navigator</h2>
                </div>
            </div>
        </template>
        <div id="shell">
        </div>
        <script>

            window.EasingFunctions = {
                // no easing, no acceleration
                linear: function (t) { return t },
                // accelerating from zero velocity
                easeInQuad: function (t) { return t*t },
                // decelerating to zero velocity
                easeOutQuad: function (t) { return t*(2-t) },
                // acceleration until halfway, then deceleration
                easeInOutQuad: function (t) { return t<.5 ? 2*t*t : -1+(4-2*t)*t },
                // accelerating from zero velocity 
                easeInCubic: function (t) { return t*t*t },
                // decelerating to zero velocity 
                easeOutCubic: function (t) { return (--t)*t*t+1 },
                // acceleration until halfway, then deceleration 
                easeInOutCubic: function (t) { return t<.5 ? 4*t*t*t : (t-1)*(2*t-2)*(2*t-2)+1 },
                // accelerating from zero velocity 
                easeInQuart: function (t) { return t*t*t*t },
                // decelerating to zero velocity 
                easeOutQuart: function (t) { return 1-(--t)*t*t*t },
                // acceleration until halfway, then deceleration
                easeInOutQuart: function (t) { return t<.5 ? 8*t*t*t*t : 1-8*(--t)*t*t*t },
                // accelerating from zero velocity
                easeInQuint: function (t) { return t*t*t*t*t },
                // decelerating to zero velocity
                easeOutQuint: function (t) { return 1+(--t)*t*t*t*t },
                // acceleration until halfway, then deceleration 
                easeInOutQuint: function (t) { return t<.5 ? 16*t*t*t*t*t : 1+16*(--t)*t*t*t*t }
            };

            let canvas = document.getElementById('canvas'),
                lastTs = 0;

            class View {
                constructor (templateId) {
                    this.shell = document.getElementById('shell');
                    this.templateId = templateId;
                }
                show () {
                    this.template = document.getElementById(this.templateId);
                    this.root = this.template.content.cloneNode(true);
                    while (this.shell.firstChild) {
                        this.shell.removeChild(this.shell.firstChild);
                    }
                    this.shell.appendChild(this.root);
                }
            }

            class InventoryUI {
                constructor (parent, game) {
                    this.parent = parent;
                    this.game = game;
                    this.root = document.createElement('ul');
                    this.root.className = 'inventory';
                    this.parent.appendChild(this.root);
                    game.level.player.inventory.on('change', () => this.render());
                    this.render();
                }

                render () {
                    this.root.innerHTML = this.game.level.player.inventory.render();
                }
            }

            class RoleScreen {
                constructor (parent, game) {
                    this.parent = parent;
                    this.game = game;
                    this.template = document.getElementById('role-screen');
                    this.root = this.template.content.cloneNode(true);
                    this.parent.appendChild(this.root);
                    shell.addEventListener('update', this.updateScore.bind(this));
                }

                reset () {
                    this.score = 0;
                }

                updateScore() {
                    let score = String(Math.floor(this.game.level.score));

                    while (score.length < 2) { score = `0${ score }`; }

                    if (score !== this.score) {
                        for (let el of document.querySelectorAll('[data-role="score"]')) {
                            el.innerHTML = score;
                            el.animate([{
                                transform: 'scale(1, 1)',
                                offset: 0
                            }, {
                                transform: 'scale(1.5, 1.5)',
                                offset: 0.2
                            }, {
                                transform: 'scale(1, 1)',
                                offset: 1
                            }], {
                                duration: 200
                            });
                        }
                    }

                    this.score = score;
                }
            }

            class MainMenu extends View {
                constructor () {
                    super('main-menu');
                    Sound.load('ui', '/assets/sounds/ui.wav');
                    Sound.load('validate', '/assets/sounds/validate.wav');
                }

                show () {
                    if (location.search.indexOf('mode=solo') !== -1) {
                        this.playSolo();
                    }

                    super.show();
                    this.ready = {};
                    this.els = {
                        driver: this.shell.querySelector('[data-role="menu-driver"]'),
                        assist: this.shell.querySelector('[data-role="menu-assist"]'),
                        start: this.shell.querySelector('[data-role="game-start"]'),
                        solo: this.shell.querySelector('[data-role="game-start-solo"]')
                    };
                    this.options = this.shell.querySelectorAll('.main-menu>div');
                    this.optionCallbacks = [];

                    for (let i = 0; i < this.options.length; i++) {
                        this.optionCallbacks.push(() => {
                            Sound.play('ui');
                        });
                        this.options[i].addEventListener('mouseenter', this.optionCallbacks[i]);
                    };

                    this.els.driver.addEventListener('click', () => {
                        this.chooseRole('driver');
                    });
                    this.els.assist.addEventListener('click', () => {
                        this.chooseRole('assist');
                    });
                    this.els.start.addEventListener('click', () => {
                        Socket.ready();
                    });
                    this.els.solo.addEventListener('click', this.playSolo.bind(this));
                    this.els.driver.setAttribute('disabled', true);
                    this.els.assist.setAttribute('disabled', true);
                    this.els.start.setAttribute('disabled', true);
                    this.els.solo.setAttribute('disabled', true);
                    Socket.connect().then((data) => {
                        ['driver', 'assist'].forEach(role => {
                            if (data.rolesTaken.indexOf(role) === -1) {
                                this.els[role].removeAttribute('disabled');
                            }
                        });
                        Socket.socket.on('role-choosen', (role) => {
                            this.els[role].setAttribute('disabled', true);
                        });

                        Socket.socket.on('all-ready', () => {
                            this.els.start.removeAttribute('disabled');
                            this.els.start.innerText = 'Start';
                        });

                        Socket.socket.on('start', (role) => {
                            this.start();
                        });
                    }).catch(e => {
                        this.els.solo.removeAttribute('disabled');
                    });
                    this.shell.animate({
                        opacity: [0, 1]
                    }, {
                        duration: 500,
                        easing: 'ease-out'
                    });
                }

                playSolo() {
                    Socket.isDriver = true;
                    Socket.role = 'driver';
                    document.body.className += ' role-driver';
                    // document.body.className += ' role-assist';
                    this.start(true);
                }

                chooseRole (role) {
                    document.body.className += ` role-${ role }`;

                    Socket.chooseRole(role).then(() => {
                        let notSelected = role === 'driver' ? 'assist' : 'driver';
                        this.els.driver.querySelector('button').setAttribute('disabled', true);
                        this.els.assist.querySelector('button').setAttribute('disabled', true);
                        this.els.driver.setAttribute('disabled', true);
                        this.els.assist.setAttribute('disabled', true);
                        this.els[role].classList.add('selected');
                        this.els[notSelected].classList.add('not-selected');
                        this.els.start.innerText = 'Waiting...';
                        this.els.solo.classList.add('blur');
                        Sound.play('validate');
                        for (let i = 0; i < this.options.length; i++) {
                            this.options[i].removeEventListener('mouseenter', this.optionCallbacks[i]);
                        }
                    });
                }

                onStart (cb) {
                    this._onStart = cb;
                }

                start (solo = false) {

                    this.shell.animate({
                        opacity: [1, 0]
                    }, {
                        duration: 500,
                        easing: 'ease-out'
                    }).onfinish = () => {
                        this._onStart(solo);
                    };
                }
            }

            class Game extends View {
                constructor (solo = false) {
                    super('game');
                    this.solo = solo;
                    this.lastTs = 0;

                    Socket.on('reset', this.reset.bind(this));
                }

                show () {
                    super.show();
                    this.roleScreen = new RoleScreen(this.shell, this);
                    Sound.load('game-over', '/assets/sounds/death.wav');
                    Sound.load('start', '/assets/sounds/start.wav');
                    this.canvas = this.shell.querySelector('#canvas');
                    this.gameOverOverlay = this.shell.querySelector('#game-over-overlay');
                    this.gameOverRetry = this.shell.querySelector('#game-over-overlay>#retry');
                    this.gameOverRetry.addEventListener('click', () => {
                        this.reset();
                    });
                    window.addEventListener('resize', this.resize.bind(this));
                    this.resize();
                    Mouse.grab(window);
                    this.ctx = this.canvas.getContext('2d');
                    this.level = new Level(this.ctx, { solo: this.solo });

                    Keyboard.grab(window);
                    Logger.setContext(this.ctx);

                    this.shell.animate({
                        opacity: [0, 1]
                    }, {
                        duration: 500,
                        easing: 'ease-out'
                    }).onfinish = () => {
                        this.level.start();
                        Sound.play('start');
                    };

                    requestAnimationFrame(this.update.bind(this));
                }

                update (ts) {
                    let dt = ts - this.lastTs;
                    this.lastTs = ts;
                    this.level.update(dt);
                    this.level.render();
                    Logger.render();
                    this.shell.dispatchEvent(new Event('update', {}));
                    if (this.level.gameOver) {
                        setTimeout(() => {
                            this.showGameOverScreen();
                        }, 500);
                    }
                    if (!this.gameOverScreen) {
                        requestAnimationFrame(this.update.bind(this));
                    }
                }

                reset () {
                    Socket.send('reset');
                    this.lastTs = 0;
                    this.gameOverScreen = false;
                    this.roleScreen.reset();
                    this.show();
                }

                showGameOverScreen () {
                    if (!this.gameOverScreen) {
                        this.gameOverScreen = true;
                        Sound.play('game-over');
                        this.gameOverOverlay.animate({
                            transform: ['scale(5, 5)', 'scale(1, 1)'],
                            opacity: [0, 1]
                        }, {
                            fill: 'forwards',
                            duration: 2000
                        });
                    }
                }

                resize () {
                    this.canvas.width = Math.min(window.innerWidth * 2, 1500);
                    this.canvas.height = window.innerHeight * 2;
                }
            }

            let mainMenu = new MainMenu();

            mainMenu.onStart(solo => {
                let game = new Game(solo);
                game.show();
                new RoleScreen(this.shell, game);
                new InventoryUI(this.shell, game);
            });

            mainMenu.show();
        </script>
    </body>
</html>